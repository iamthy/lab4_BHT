# 体系结构第四次实验报告

> PB17061227 唐华楹
>
> 实验环境：
>
> Windows10家庭中文版
>
> Vivado 2018.2

## 实验目的

* 理解分支预测的原理，并用verilog实现
* 比较BTB和BHT的不同与它们对提高预测准确率的作用

## 实验过程

BHT逻辑表如下：

| BTB  | BHT  | REAL | NPC_PRED | flush | NPC_REAL | BTB update |
| :--: | :--: | :--: | :------: | :---: | :------: | :--------: |
|  Y   |  Y   |  Y   |   BUF    |   N   |   BUF    |     N      |
|  Y   |  Y   |  N   |   BUF    |   Y   | PC_EX+4  |     Y      |
|  Y   |  N   |  Y   | PC_IF+4  |   Y   |   BUF    |     N      |
|  Y   |  N   |  N   | PC_IF+4  |   N   | PC_EX+4  |     Y      |
|  N   |  Y   |  Y   | PC_IF+4  |   Y   |   BUF    |     Y      |
|  N   |  Y   |  N   | PC_IF+4  |   N   | PC_EX+4  |     N      |
|  N   |  N   |  Y   | PC_IF+4  |   Y   |   BUF    |     Y      |
|  N   |  N   |  N   | PC_IF+4  |   N   | PC_EX+4  |     N      |
### 阶段一 实现BTB

#### 情况分析

BTB对所有指令的预测如下：

* 在BTB中且state为1，返回predicted PC作为预测地址给NPC Generator
* （在BTB中且state为0）或者不在BTB中，返回PC+4作为预测地址给NPC Generator

##### 1.BTB中未找到

* BTB预测不跳转，Predicted PC=PC+4。
* 在EX段根据情况作出如下处理：
  * 不是分支指令：BTB不用更新，对这条指令维持PC+4的预测。
  * **是分支指令，但是不跳转：也不更新BTB，对这条指令维持PC+4的预测。不更新BTB的原因是这样就能只用一个条目同时预测两个同tag的分支指令。预测不跳转的分支指令不需要加入BTB也能正确给出预测地址为PC+4。**
  * 是分支指令，且跳转：更新BTB，用PC更新BTB中的BranchPC，用真实目标地址br_target更新Predicted PC，state设为1。对Hazard模块和NPC_Generator发出预测失败信号BTB_fail，Hazard模块控制流水线flush，NPC_Generator将新的PC值设为br_target。

##### 2.BTB中找到

* BTB对应条目的state为1
  * 预测跳转，给出Predicted PC作为预测地址。
  * 在EX段根据情况作出如下处理：
    * 不是分支指令：说明该地址的指令发生了变化，从分支指令变为了非分支指令。BTB更新Predicted PC为PC+4，state设为0，以后不再对该指令预测跳转，等待同tag的分支指令来替换它。Hazard模块控制流水线flush，NPC_Generator将新的PC值设为PC_EX+4。
    * 是分支指令，但是不跳转：不更新BTB的BranchPC和Predicted PC，但是预测位state设为0。Hazard模块控制流水线flush，NPC_Generator将新的PC值设为PC_EX+4。
    * 是分支指令，但是跳转：预测正确，不需要做额外处理。

* BTB中对应条目的state为0
  * 预测不跳转，给出Predicted PC作为预测地址。
  * 在EX段根据情况作出如下处理：
    * 不是分支指令：当前的判断没有问题，保持BTB不变
    * 是分支指令，但是不跳转：预测正确，保持BTB不变
    * 是分支指令，但是跳转：更新BTB的Predicted PC为真实目标地址br_target，并且预测位state设为1。Hazard模块控制流水线flush，NPC_Generator将新的PC值设为br_target。

#### 一些实现细节

首先要增加一个BTB，包含一定数量的条目，每个条目记录分支指令的PC和预测跳转的PC以及预测位（0/1）。实现用类似直接映射的方法。

还需要把预测信息传递到EX段和真实跳转情况作比较以更新BTB。

### 阶段二 实现BHT

#### 阶段目标

* 在阶段一基础上实现一个BHT预测器
* 结合BHT与BTB实现分支预测

#### 具体实现细节

* BHT相比BTB，不再记录分支指令的PC值，而是只有一个两位的状态机以预测跳转与否
* 由于不记录PC所以也不处理tag相同的指令，交由BTB根据是否命中判断
* 返回结果只有是否跳转
* 同样在EX段根据实际跳转情况更新BHT中的值
* 最终预测结果只有在BTB命中且BHT预测跳转时才会预测跳转

## 实验结果与分析

本次实验中仿真时设置的一个周期为4ns。

分支预测带来的直接收益就是预测正确的情况下，可以节约两个流水线周期的时间。那么分支预测的直接收益就是正确次数*2个周期。相对于完全预测正确的情况，时间上的分支直接代价就是预测的错误次数\*2个周期.

下表为实验数据，矩阵乘法的矩阵大小为16*16，快速排序的规模为256个数，cache为实验3中的LRU8组4路cache。

| 程序     | 无预测用时/ns | 策略 | 分支次数 | 正确次数 | 错误次数 | 运行时间/ns | 时间差（相比无预测）/ns | 分支直接收益/周期 | 分支直接代价/周期 |
| -------- | ------------- | ---- | -------- | -------- | -------- | ----------- | ----------------------- | ----------------- | ----------------- |
| BTB.S    | 2048          | BTB  | 101      | 99       | 2        | 1264        | 784                     | 198               | 4                 |
|          |               | 结合 | 101      | 99       | 2        | 1264        | 784                     | 198               | 4                 |
| BHT.S    | 2152          | BTB  | 110      | 88       | 22       | 1536        | 616                     | 176               | 44                |
|          |               | 结合 | 110      | 97       | 13       | 1464        | 688                     | 194               | 26                |
| 矩阵乘法 | 794836        | BTB  | 4368     | 3822     | 546      | 706404      | 88432                   | 7644              | 1092              |
|          |               | 结合 | 4368     | 4092     | 276      | 665764      | 129072                  | 8184              | 552               |
| 快速排序 | 185768        | BTB  | 6723     | 4631     | 2092     | 149340      | 36428                   | 9262              | 4184              |
|          |               | 结合 | 6723     | 5607     | 1116     | 141956      | 43812                   | 10578             | 2232              |

从以上的数据可以看出，分支预测能有效提高程序的执行效率，缩短执行时间。而有BTB与2bit-BHT的分支预测器的预测效果又好于只有BTB的分支预测器。

## 实验总结

通过这次实验，我加深了对BTB与BHT原理的了解，并分析了不同分支预测方法的优劣。体会到分支预测技术对流水线性能优化的意义。

